import { serve } from "https://deno.land/std@0.190.0/http/server.ts";
import {
  corsHeaders,
  signedAWSRequest,
  parseXMLValue,
  isAWSConfigured,
  EMAIL_CONFIG,
} from "../_shared/aws-config.ts";

interface NotifyRequest {
  customerName: string;
  customerEmail: string;
  vehicleName: string;
  vehicleReg: string;
  bookingRef: string;
  envelopeId: string;
  signedAt: string;
  documentUrl?: string;
}

const getAdminEmailHtml = (data: NotifyRequest) => {
  return `
<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title>DocuSign Completed</title></head>
<body style="margin: 0; padding: 20px; font-family: Arial, sans-serif; background-color: #f5f5f5;">
    <table style="width: 100%; max-width: 600px; margin: 0 auto; background: white; border-radius: 8px; overflow: hidden;">
        <tr>
            <td style="background: #1a1a1a; padding: 20px; text-align: center;">
                <h1 style="margin: 0; color: #C5A572; font-size: 24px;">DRIVE 247 ADMIN</h1>
            </td>
        </tr>
        <tr>
            <td style="padding: 30px;">
                <div style="text-align: center; margin-bottom: 25px;">
                    <span style="display: inline-block; background: #ecfdf5; color: #10b981; padding: 8px 20px; border-radius: 20px; font-weight: 600; font-size: 14px;">
                        CONTRACT SIGNED
                    </span>
                </div>
                <h2 style="margin: 0 0 20px; color: #10b981;">Rental Agreement Signed</h2>
                <p style="margin: 0 0 20px; color: #444;">A customer has completed signing their rental agreement via DocuSign.</p>
                <table style="width: 100%; border-collapse: collapse; background: #f8f9fa; border-radius: 8px;">
                    <tr><td style="padding: 12px; border-bottom: 1px solid #e5e7eb; color: #666;">Booking Reference:</td><td style="padding: 12px; border-bottom: 1px solid #e5e7eb; font-weight: 600;">${data.bookingRef}</td></tr>
                    <tr><td style="padding: 12px; border-bottom: 1px solid #e5e7eb; color: #666;">Customer:</td><td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${data.customerName}</td></tr>
                    <tr><td style="padding: 12px; border-bottom: 1px solid #e5e7eb; color: #666;">Email:</td><td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${data.customerEmail}</td></tr>
                    <tr><td style="padding: 12px; border-bottom: 1px solid #e5e7eb; color: #666;">Vehicle:</td><td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${data.vehicleName} (${data.vehicleReg})</td></tr>
                    <tr><td style="padding: 12px; border-bottom: 1px solid #e5e7eb; color: #666;">Signed At:</td><td style="padding: 12px; border-bottom: 1px solid #e5e7eb; color: #10b981;">${data.signedAt}</td></tr>
                    <tr><td style="padding: 12px; color: #666;">Envelope ID:</td><td style="padding: 12px; font-family: monospace; font-size: 12px;">${data.envelopeId}</td></tr>
                </table>
                ${data.documentUrl ? `
                <div style="text-align: center; margin-top: 25px;">
                    <a href="${data.documentUrl}" style="display: inline-block; background: #C5A572; color: white; padding: 12px 30px; border-radius: 6px; text-decoration: none; font-weight: 600;">View Signed Document</a>
                </div>
                ` : ''}
                <p style="margin: 25px 0 0; color: #666; font-size: 14px;">The rental is now ready for pickup. All paperwork is complete.</p>
            </td>
        </tr>
    </table>
</body>
</html>
`;
};

async function sendEmail(to: string, subject: string, html: string) {
  if (!isAWSConfigured()) {
    console.log('AWS not configured, simulating email send');
    console.log('To:', to);
    console.log('Subject:', subject);
    return { success: true, simulated: true };
  }

  const fromEmail = EMAIL_CONFIG.fromEmail;
  const params: Record<string, string> = {
    'Action': 'SendEmail',
    'Version': '2010-12-01',
    'Source': fromEmail,
    'Destination.ToAddresses.member.1': to,
    'Message.Subject.Data': subject,
    'Message.Subject.Charset': 'UTF-8',
    'Message.Body.Html.Data': html,
    'Message.Body.Html.Charset': 'UTF-8',
  };

  const body = Object.entries(params)
    .map(([key, value]) => `${encodeURIComponent(key)}=${encodeURIComponent(value)}`)
    .join('&');

  const response = await signedAWSRequest({
    service: 'ses',
    method: 'POST',
    body,
  });

  const responseText = await response.text();
  if (!response.ok) {
    console.error('SES Error:', responseText);
    return { success: false, error: parseXMLValue(responseText, 'Message') };
  }

  return { success: true, messageId: parseXMLValue(responseText, 'MessageId') };
}

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const data: NotifyRequest = await req.json();
    console.log('Sending DocuSign completed notification for:', data.bookingRef);

    const results = {
      adminEmail: null as any,
    };

    // Send admin email
    const adminEmail = EMAIL_CONFIG.adminEmail;
    results.adminEmail = await sendEmail(
      adminEmail,
      `Contract Signed - ${data.bookingRef} - ${data.customerName} | DRIVE 247`,
      getAdminEmailHtml(data)
    );
    console.log('Admin email result:', results.adminEmail);

    return new Response(
      JSON.stringify({ success: true, results }),
      {
        status: 200,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      }
    );
  } catch (error) {
    console.error('Error sending notifications:', error);
    return new Response(
      JSON.stringify({ success: false, error: error.message }),
      {
        status: 500,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      }
    );
  }
});
